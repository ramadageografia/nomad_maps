<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="assets/JS/trance-map.js"></script>
<script>
// Mapeamento de Ã­cones por subgÃªnero
const subgenreIcons = {
    'Psytrance': 'assets/Imagens/icones/psytrance.png',
    'Progressive': 'assets/Imagens/icones/progressive.png', 
    'Full On': 'assets/Imagens/icones/fullon.png',
    'Darkpsy': 'assets/Imagens/icones/darkpsy.png',
    'Goa': 'assets/Imagens/icones/goa.png',
    'Zenonesque': 'assets/Imagens/icones/zenonesque.png',
    'Hi-Tech': 'assets/Imagens/icones/hitech.png',
    'Forest': 'assets/Imagens/icones/forest.png',
    'Suomi': 'assets/Imagens/icones/suomi.png',
    'default': 'assets/Imagens/icones/psytrance.png'
};

// Mapeamento de bandeiras por paÃ­s (vamos comeÃ§ar com os principais)
const countryFlags = {
    'Brasil': 'ğŸ‡§ğŸ‡·',
    'Portugal': 'ğŸ‡µğŸ‡¹', 
    'Espanha': 'ğŸ‡ªğŸ‡¸',
    'Alemanha': 'ğŸ‡©ğŸ‡ª',
    'FranÃ§a': 'ğŸ‡«ğŸ‡·',
    'ItÃ¡lia': 'ğŸ‡®ğŸ‡¹',
    'GrÃ©cia': 'ğŸ‡¬ğŸ‡·',
    'Israel': 'ğŸ‡®ğŸ‡±',
    'Ãndia': 'ğŸ‡®ğŸ‡³',
    'JapÃ£o': 'ğŸ‡¯ğŸ‡µ',
    'AustrÃ¡lia': 'ğŸ‡¦ğŸ‡º',
    'Chile': 'ğŸ‡¨ğŸ‡±',
    'Argentina': 'ğŸ‡¦ğŸ‡·',
    'MÃ©xico': 'ğŸ‡²ğŸ‡½',
    'EUA': 'ğŸ‡ºğŸ‡¸',
    'CanadÃ¡': 'ğŸ‡¨ğŸ‡¦'
};

// FunÃ§Ã£o para criar Ã­cone personalizado
function createCustomIcon(festival, categoryType) {
    let iconUrl;
    let iconSize = [30, 30];
    
    if (categoryType === 'subgenero') {
        // Ãcone por subgÃªnero musical
        const mainSubgenre = festival.subgeneros && festival.subgeneros.length > 0 
            ? festival.subgeneros[0] 
            : 'default';
        iconUrl = subgenreIcons[mainSubgenre] || subgenreIcons['default'];
    } 
    else if (categoryType === 'pais') {
        // Bandeira do paÃ­s (usando emoji por enquanto)
        const flag = countryFlags[festival.pais] || 'ğŸµ';
        // Criar um Ã­cone com a bandeira - por enquanto usando marcador padrÃ£o
        iconUrl = 'assets/Imagens/icones/psytrance.png'; // placeholder
        iconSize = [25, 25];
    }
    else if (categoryType === 'continente') {
        // Ãcone por continente
        const continentIcons = {
            'AmÃ©rica do Sul': 'assets/Imagens/icones/southamerica.png',
            'AmÃ©rica do Norte': 'assets/Imagens/icones/northamerica.png', 
            'Europa': 'assets/Imagens/icones/europe.png',
            'Ãsia': 'assets/Imagens/icones/asia.png',
            'Oceania': 'assets/Imagens/icones/oceania.png',
            'Ãfrica': 'assets/Imagens/icones/africa.png'
        };
        iconUrl = continentIcons[festival.continente] || subgenreIcons['default'];
    }
    else {
        // Categoria por nome (Ã­cone padrÃ£o psytrance)
        iconUrl = subgenreIcons['default'];
    }
    
    return L.icon({
        iconUrl: iconUrl,
        iconSize: iconSize,
        iconAnchor: [15, 15],
        popupAnchor: [0, -15],
        className: 'custom-marker'
    });
}

// VariÃ¡veis globais
let map;
let currentMarkers = L.layerGroup();
let currentCategory = 'subgenero';

// Inicializar mapa
function initMap() {
    map = L.map('map').setView([-14.2350, -51.9253], 3);
    
    // Camada do mapa estilo escuro (igual Google My Maps)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â©OpenStreetMap, Â©CartoDB',
        maxZoom: 20
    }).addTo(map);
    
    // Adicionar grupo de marcadores
    currentMarkers.addTo(map);
    
    // Carregar festivais
    loadFestivals();
}

// Carregar e exibir festivais
function loadFestivals() {
    if (!window.festivalsData || window.festivalsData.length === 0) {
        console.error('âŒ Nenhum dado encontrado em festivalsData');
        return;
    }
    
    console.log(`ğŸª Carregando ${window.festivalsData.length} festivais...`);
    updateFestivalsByCategory(currentCategory);
}

// Atualizar marcadores por categoria
function updateFestivalsByCategory(category) {
    currentCategory = category;
    currentMarkers.clearLayers();
    
    window.festivalsData.forEach(festival => {
        if (festival.latitude && festival.longitude) {
            const lat = parseFloat(festival.latitude);
            const lng = parseFloat(festival.longitude);
            
            // Criar Ã­cone baseado na categoria selecionada
            const customIcon = createCustomIcon(festival, category);
            
            // Criar marcador
            const marker = L.marker([lat, lng], { icon: customIcon });
            
            // Criar popup informativo
            const popupContent = createPopupContent(festival);
            marker.bindPopup(popupContent);
            
            // Adicionar ao grupo
            marker.addTo(currentMarkers);
        }
    });
    
    updateLegend(category);
}

// Criar conteÃºdo do popup
function createPopupContent(festival) {
    return `
        <div class="festival-popup" style="color: #0f0c29; min-width: 280px; font-family: Arial, sans-serif;">
            <h3 style="color: #6a11cb; margin-bottom: 10px; border-bottom: 2px solid #ff00cc; padding-bottom: 5px;">
                ${festival.nome}
            </h3>
            
            <div style="margin-bottom: 8px;">
                <strong>ğŸ“ ${festival.cidade}, ${festival.pais}</strong>
            </div>
            
            <div style="margin-bottom: 8px;">
                <strong>ğŸŒ ${festival.continente}</strong>
            </div>
            
            <div style="margin-bottom: 8px;">
                <strong>ğŸ“… ${festival.mes_temporada || 'Data a confirmar'}</strong>
            </div>
            
            <div style="margin-bottom: 10px;">
                <strong>ğŸµ ${festival.subgeneros ? festival.subgeneros.join(', ') : 'Psytrance'}</strong>
            </div>
            
            <div style="margin-bottom: 10px; padding: 5px; background: #f0f0f0; border-radius: 5px;">
                <strong>Status:</strong> 
                <span style="color: ${festival.status === 'Ativo' ? 'green' : 'gray'};">
                    ${festival.status === 'Ativo' ? 'ğŸŸ¢ Ativo' : 'âš« Inativo'}
                </span>
            </div>
            
            ${festival.link ? `
            <div style="margin-top: 10px;">
                <a href="${festival.link}" target="_blank" 
                   style="color: #2575fc; text-decoration: none; font-weight: bold;">
                   ğŸ”— Site Oficial
                </a>
            </div>
            ` : ''}
            
            ${festival.instagram ? `
            <div>
                <a href="https://instagram.com/${festival.instagram}" target="_blank"
                   style="color: #e1306c; text-decoration: none; font-weight: bold;">
                   ğŸ“¸ Instagram
                </a>
            </div>
            ` : ''}
        </div>
    `;
}

// Atualizar legenda
function updateLegend(category) {
    const legend = document.getElementById('mapLegend');
    if (!legend) return;
    
    let legendHTML = '<h4>Legenda</h4>';
    
    if (category === 'subgenero') {
        legendHTML += `
            <div class="legend-item"><div class="legend-color" style="background-image: url('assets/Imagens/icones/psytrance.png'); background-size: cover;"></div><span>Psytrance</span></div>
            <div class="legend-item"><div class="legend-color" style="background-image: url('assets/Imagens/icones/progressive.png'); background-size: cover;"></div><span>Progressive</span></div>
            <div class="legend-item"><div class="legend-color" style="background-image: url('assets/Imagens/icones/fullon.png'); background-size: cover;"></div><span>Full On</span></div>
            <div class="legend-item"><div class="legend-color" style="background-image: url('assets/Imagens/icones/darkpsy.png'); background-size: cover;"></div><span>Darkpsy</span></div>
            <div class="legend-item"><div class="legend-color" style="background-image: url('assets/Imagens/icones/goa.png'); background-size: cover;"></div><span>Goa</span></div>
        `;
    }
    else if (category === 'pais') {
        legendHTML += `
            <div class="legend-item"><div class="legend-color" style="background: #ff00cc;"></div><span>Brasil ğŸ‡§ğŸ‡·</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #2575fc;"></div><span>Portugal ğŸ‡µğŸ‡¹</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #00ff99;"></div><span>Outros PaÃ­ses</span></div>
        `;
    }
    else if (category === 'continente') {
        legendHTML += `
            <div class="legend-item"><div class="legend-color" style="background: #ff00cc;"></div><span>AmÃ©rica do Sul</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #2575fc;"></div><span>Europa</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #00ff99;"></div><span>AmÃ©rica do Norte</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #ff9900;"></div><span>Ãsia</span></div>
        `;
    }
    
    legend.innerHTML = legendHTML;
}

// Inicializar quando a pÃ¡gina carregar
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    // Event listeners para os botÃµes de categoria
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            updateFestivalsByCategory(category);
            
            // Atualizar botÃ£o ativo
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
});
</script>

<style>
/* Estilos para os controles de categoria */
.category-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: rgba(15, 12, 41, 0.9);
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #ff00cc;
}

.category-btn {
    display: block;
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid #2575fc;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.category-btn:hover,
.category-btn.active {
    background: #ff00cc;
    transform: translateY(-2px);
}

/* Legenda do mapa */
.map-legend {
    position: absolute;
    bottom: 20px;
    left: 10px;
    background: rgba(15, 12, 41, 0.9);
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #00ff99;
    z-index: 1000;
    max-width: 200px;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 10px;
    border: 2px solid white;
}

.custom-marker {
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
}
</style>
